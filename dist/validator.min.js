"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function r(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),e}}(),_moment2=_interopRequireDefault(_moment=require("moment")),_lodash2=_interopRequireDefault(_lodash=require("lodash")),_assume2=_interopRequireDefault(_assume=require("@padresmurfa/assume")),_validationFailed2=_interopRequireDefault(_validationFailed=require("./validation-failed"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function rename(e,t){return Object.defineProperty(t,"name",{value:e}),t}var Compiled=function(){function t(e){_classCallCheck(this,t),this.checks=[],this.property=e}return _createClass(t,[{key:"check",value:function(t){var i=this;_lodash2.default.forEach(this.checks,function(e){i.checkProperty(e,t[e.propName])})}},{key:"checkProperty",value:function(e,t){var i=!0===this.property[e.propName].expectNullable,r=!1===this.property[e.propName].expectDefined;null===t&&i||void 0===t&&r||e.method(t)}},{key:"add",value:function(e,t,i){this.checks.push({propName:e,condition:t,method:i})}}]),t}(),Compiler=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"compile",value:function(e,t,i){_assume2.default.isObject(e,"Can only check known properties of objects");var n=new Compiled(e);return _lodash2.default.forEach(e,function(r,e){var a=i(t+"/"+e);!0===r.expectUndefined&&n.add(e,"isUndefined",a.isUndefined),!0===r.expectDefined&&n.add(e,"isDefined",a.isDefined),!0===r.expectNotEmpty&&n.add(e,"isNotEmpty",a.isNotEmpty),!0===r.expectEmpty&&n.add(e,"isEmpty",a.isEmpty),!0===r.expectString&&n.add(e,"isString",a.isString),!0===r.expectArray&&n.add(e,"isArray",a.isArray),!0===r.expectDate&&n.add(e,"isDate",a.isDate),!0===r.expectInteger&&n.add(e,"isInteger",a.isInteger),!0===r.expectBoolean&&n.add(e,"isBoolean",a.isBoolean),!0===r.expectObject&&n.add(e,"isObject",a.isObject),!0===r.expectIsoDate&&n.add(e,"isIsoDate",a.isIsoDate),!0===r.expectImmutable&&n.add(e,"isImmutable",a.isImmutable),void 0!==r.itemValidator&&n.add(e,"isArrayItem",function(e){_lodash2.default.forEach(e,function(e){r.itemValidator.check(e)})}),void 0!==r.objectValidator&&n.add(e,"isObject",r.objectValidator.check),void 0!==r.uniqueCriteria&&n.add(e,"isUnique",function(e){var t=e.length,i=_lodash2.default.uniqBy(e,r.uniqueCriteria).length;a.areEqual(t,i,void 0)}),void 0!==r.expectInstanceOf&&n.add("isInstanceOf",function(e){a.isInstanceOf(e,r.expectInstanceOf)})}),n}}]),e}();exports.default=Compiler.compile,Object.defineProperty(exports,"__esModule",{value:!0}),exports.ValidationFailed=exports.Validator=void 0;var _validator=require("./validator"),_validator2=_interopRequireDefault(_validator);_validationFailed2=_interopRequireDefault(_validationFailed=require("./validation-failed"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}exports.default=_validator2.default.create,exports.Validator=_validator2.default,exports.ValidationFailed=_validationFailed2.default,Object.defineProperty(exports,"__esModule",{value:!0});var _assume=require("@padresmurfa/assume");function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var ValidationFailed=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,_assume.AssumptionFailed),t}();exports.default=ValidationFailed,Object.defineProperty(exports,"__esModule",{value:!0});_createClass=function(){function r(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),e}}(),_moment2=_interopRequireDefault(_moment=require("moment")),_lodash2=_interopRequireDefault(_lodash=require("lodash"));var _moment,_lodash,_validationFailed,_binding=require("@padresmurfa/binding"),_binding2=_interopRequireDefault(_binding),_compiler=(_assume2=_interopRequireDefault(_assume=require("@padresmurfa/assume")),require("./compiler")),_compiler2=_interopRequireDefault(_compiler);_validationFailed2=_interopRequireDefault(_validationFailed=require("./validation-failed"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function isWhiteSpace(e){return!/\S/.test(myString)}function validate(i){return _binding2.default.JIT(_assume.Assume,function(e){var t=i+": "+e;return new _validationFailed2.default(t)})}function toComparable(e){return _lodash2.default.isDate(e)?e.getTime():e}var Validator=function(){function a(e){_classCallCheck(this,a),this.__identifier=e,this.__propertyName=null,this.__storage={},this.__compiled=null}return _createClass(a,[{key:"property",value:function(e){return void 0===e?this.__storage[this.__propertyName]||null:(this.__propertyName!==e&&(this.__propertyName=e,void 0===this.__storage[e]&&(this.__storage[e]={}),this.required()),this)}},{key:"hasProperty",value:function(e){return void 0!==this.__storage[e]}},{key:"path",value:function(){return null===this.__propertyName?this.__identifier:this.__identifier+"/"+this.__propertyName}},{key:"clone",value:function(e){if(!_lodash2.default.isString(e)||isWhiteSpace(e))throw new Error("Clones must have a variant name");return new a(this.path()+":"+e)}},{key:"immutable",value:function(e){return void 0!==e&&this.property(e),this.__updateProperty("Only properties may be expected to be immutable").expectImmutable=!0,this}},{key:"string",value:function(e){void 0!==e&&this.property(e);var t=this.__updateProperty("Only properties may be expected to be strings");return t.expectString=!0,t.expectImmutable=!0,t.expectNullable=!1,this}},{key:"integer",value:function(e){void 0!==e&&this.property(e);var t=this.__updateProperty("Only properties may be expected to be integers");return t.expectInteger=!0,t.expectImmutable=!0,t.expectNullable=!1,this}},{key:"boolean",value:function(e){void 0!==e&&this.property(e);var t=this.__updateProperty("Only properties may be expected to be booleans");return t.expectBoolean=!0,t.expectImmutable=!0,t.expectNullable=!1,this}},{key:"date",value:function(e){void 0!==e&&this.property(e);var t=this.__updateProperty("Only properties may be expected to be dates");return t.expectDate=!0,t.expectNullable=!1,this}},{key:"isoDate",value:function(e){void 0!==e&&this.property(e);var t=this.__updateProperty("Only properties may be expected to be ISO dates");return t.expectIsoDate=!0,t.expectImmutable=!0,t.expectNullable=!1,this}},{key:"required",value:function(e){void 0!==e&&this.property(e);var t=this.__updateProperty("Only properties may be expected to be defined");return t.expectDefined=!0,t.expectUndefined=!1,this}},{key:"absent",value:function(e){void 0!==e&&this.property(e);var t=this.__updateProperty("Only properties may be expected to be undefined");return t.expectDefined=!1,t.expectUndefined=!0,this}},{key:"optional",value:function(e){void 0!==e&&this.property(e);var t=this.__updateProperty("Only properties may be expected to be optionally defined");return t.expectDefined=!1,t.expectUndefined=!1,this}},{key:"nullable",value:function(e){return void 0!==e&&this.property(e),this.__updateProperty("Only properties may be expected to be nullable").expectNullable=!0,this}},{key:"empty",value:function(e){return void 0!==e&&this.property(e),this.__updateProperty("Only properties may be expected to be empty").expectEmpty=!0,this}},{key:"notEmpty",value:function(e){return void 0!==e&&this.property(e),this.__updateProperty("Only properties may be expected to be not empty").expectNotEmpty=!0,this}},{key:"array",value:function(e,t){void 0!==e&&(_lodash2.default.isFunction(e)?t=e:this.property(e));var i=this.__updateProperty("Only properties may be expected to be an array");if(i.expectArray=!0,i.expectNullable=!1,void 0!==t){var r=a.create(this.path()).property(":array-item").optional();i.itemValidator=t(r)}return this}},{key:"__self",value:function(){return this}},{key:"object",value:function(e,t){void 0!==e&&(_lodash2.default.isFunction(e)?t=e:this.property(e));var i=this.__updateProperty("Only properties may be expected to be an object");if(i.expectObject=!0,i.expectNullable=!1,void 0!==t){var r=a.create(this.path()).property(":self");i.objectValidator=t(r)}return this}},{key:"instanceOf",value:function(e,t){return void 0!==e&&(_lodash2.default.isUndefined(t)?t=e:this.object(e)),this.__updateProperty("Only properties may be expected to be instances").expectInstanceOf=(0,_assume.normalizeClassNames)(t),this}},{key:"unique",value:function(i,e){var t=this.__updateProperty("Only properties may have unique criteria");if(!0!==t.expectArray)throw new Error("Only arrays can be declared to have unique children");if(void 0===i){var r=this.path();t.expectUniqueCollection=!0,t.uniqueCriteria=function(e){return e=toComparable(e),validate(r).isImmutable(e,"Only immutable items can be placed in unique properties using default uniqueness"),e}}else if(_lodash2.default.isString(i)){var a=this.path();t.expectUniqueCollection=!0,t.uniqueCriteria=function(e){var t=e[i];return t=toComparable(t),validate(a).isImmutable(t,"Only immutable items can be placed in unique properties"),t}}else{if(!_lodash2.default.isFunction(i))throw new Error("Unique criteria can only be specified on array-item object properties or immutable array-items");var n=this.path();t.expectUniqueCollection=!0,t.uniqueCriteria=function(e){var t=i(e);return t=toComparable(t),validate(n).isImmutable(t,"Only immutable items can be placed in unique properties"),t}}return void 0!==e&&(t.uniqueCriteriaMsg=e),this}},{key:"check",value:function(e){return _assume2.default.isInstanceOf(this,"Validator","Check called with incorrect this pointer.  Expected a Validator"),this.compiled().check(e)}},{key:"__readProperty",value:function(e){var t=this.property();if(null===t)throw new Error(e);return t}},{key:"__updateProperty",value:function(e){var t=this.__readProperty(e);return this.__compiled=null,t}},{key:"compiled",value:function(e){return void 0===e?(null===this.__compiled&&(this.__compiled=(0,_compiler2.default)(this.__storage,this.__identifier,validate)),this.__compiled):(this.__compiled=e,this)}}],[{key:"create",value:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return new(Function.prototype.bind.apply(a,[null].concat(t)))}}]),a}();exports.default=Validator;
